name: GitHub Alerts

on:
  schedule:
    - cron: '*/30 * * * *'  # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  monitor-github:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install axios
      
      - name: Debug environment
        env:
          PERSONAL_GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          MY_GITHUB_USERNAME: ${{ secrets.MY_GITHUB_USERNAME }}
          REPOS_TO_MONITOR: ${{ secrets.REPOS_TO_MONITOR }}
        run: |
          node -e "
          console.log('í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹…:');
          console.log('GITHUB_TOKEN:', process.env.PERSONAL_GITHUB_TOKEN ? 'ìˆìŒ (ê¸¸ì´: ' + process.env.GITHUB_TOKEN.length + ')' : 'ì—†ìŒ');
          console.log('DISCORD_WEBHOOK_URL:', process.env.DISCORD_WEBHOOK_URL ? 'ìˆìŒ (ê¸¸ì´: ' + process.env.DISCORD_WEBHOOK_URL.length + ')' : 'ì—†ìŒ');          console.log('GITHUB_USERNAME:', process.env.GITHUB_USERNAME ? 'ìˆìŒ (' + process.env.GITHUB_USERNAME + ')' : 'ì—†ìŒ');
          console.log('MY_GITHUB_USERNAME:', process.env.MY_GITHUB_USERNAME ? 'ìˆìŒ (' + process.env.MY_GITHUB_USERNAME + ')' : 'ì—†ìŒ');
          "
      
      - name: Create notification script
        run: |
          cat > github-monitor.js << 'EOL'
          const axios = require('axios');

          const GITHUB_TOKEN = process.env.PERSONAL_GITHUB_TOKEN;
          const DISCORD_WEBHOOK_URL = process.env.DISCORD_WEBHOOK_URL;
          const GITHUB_USERNAME = process.env.MY_GITHUB_USERNAME;
          
          // JSON ë¬¸ìì—´ë¡œ ì €ì¥ëœ ì €ì¥ì†Œ ëª©ë¡ì„ íŒŒì‹±
          const REPOS_TO_MONITOR = JSON.parse(process.env.REPOS_TO_MONITOR || '[]');
          
          // ë§ˆì§€ë§‰ í™•ì¸ ì‹œê°„ (30ë¶„ë³´ë‹¤ ì•½ê°„ ê¸¸ê²Œ ì„¤ì •)
          const lastCheckedTime = new Date();
          lastCheckedTime.setMinutes(lastCheckedTime.getMinutes() - 35); // 30ë¶„ + 5ë¶„ ì—¬ìœ 
          
          console.log('GitHub ì•Œë¦¼ ì²´ì»¤ ì‹œì‘ë¨');
          console.log('ëª¨ë‹ˆí„°ë§ ì¤‘ì¸ ì €ì¥ì†Œ:', REPOS_TO_MONITOR);
          console.log('ì‚¬ìš©ì:', GITHUB_USERNAME);
          console.log('ë§ˆì§€ë§‰ í™•ì¸ ì‹œê°„:', lastCheckedTime.toISOString());
          
          // GitHub API í˜¸ì¶œ ì„¤ì •
          const githubAPI = axios.create({
            baseURL: 'https://api.github.com',
            headers: {
              Authorization: `token ${GITHUB_TOKEN}`,
              Accept: 'application/vnd.github.v3+json'
            }
          });
          
          // GitHub APIì— ì‚¬ìš©í•  ì¶”ê°€ í—¤ë” (Discussions APIìš©)
          const discussionsHeader = {
            headers: {
              Authorization: `token ${GITHUB_TOKEN}`,
              Accept: 'application/vnd.github.v3+json,application/vnd.github.squirrel-girl-preview'
            }
          };

          // ìƒˆ ì´ìŠˆ/ì´ìŠˆ ëŒ“ê¸€ í™•ì¸
          async function checkForNewIssuesAndComments() {
            console.log('ì´ìŠˆ ë° ì´ìŠˆ ëŒ“ê¸€ í™•ì¸ ì¤‘...');
            
            for (const repoFullName of REPOS_TO_MONITOR) {
              const [owner, repo] = repoFullName.split('/');
              
              try {
                // 1. ë‚˜ì—ê²Œ í• ë‹¹ëœ ì´ìŠˆ í™•ì¸
                const assignedIssues = await githubAPI.get(`/repos/${owner}/${repo}/issues`, {
                  params: { 
                    state: 'open', 
                    assignee: GITHUB_USERNAME,
                    since: lastCheckedTime.toISOString()
                  }
                });
                
                console.log(`${assignedIssues.data.length}ê°œì˜ ìƒˆë¡œ í• ë‹¹ëœ ì´ìŠˆ ë°œê²¬`);
                
                // ìƒˆë¡œ í• ë‹¹ëœ ì´ìŠˆ ì•Œë¦¼
                for (const issue of assignedIssues.data) {
                  // PRì´ ì•„ë‹Œ ì´ìŠˆë§Œ ì²˜ë¦¬ (PRë„ ì´ìŠˆë¡œ ë°˜í™˜ë¨)
                  if (!issue.pull_request) {
                    // ì´ìŠˆ ìƒì„± ì‹œê°„ì„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                    const issueTime = new Date(issue.created_at);
                    const koreaTimeOptions = { 
                      timeZone: 'Asia/Seoul', 
                      year: 'numeric', 
                      month: '2-digit', 
                      day: '2-digit',
                      hour: '2-digit', 
                      minute: '2-digit'
                    };
                    const issueTimeStr = issueTime.toLocaleString('ko-KR', koreaTimeOptions);
                    
                    // ì´ìŠˆ ë‚´ìš© ìš”ì•½
                    const issueBody = issue.body ? truncateText(issue.body, 200) : '(ë‚´ìš© ì—†ìŒ)';
                    
                    await sendDiscordNotification({
                      title: `ğŸ“Œ ìƒˆ ì´ìŠˆê°€ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤: #${issue.number}`,
                      description: `**ì´ìŠˆ**: ${issue.title}\n**ì‘ì„±ì**: ${issue.user.login}\n**ì‘ì„± ì‹œê°„**: ${issueTimeStr}\n\n**ë‚´ìš© ìš”ì•½**:\n${issueBody}`,
                      url: issue.html_url,
                      author: issue.user.login,
                      repo: `${owner}/${repo}`
                    });
                  }
                }
                
                // 2. ë‚´ê°€ ìƒì„±í•œ ì´ìŠˆì— ë‹¬ë¦° ìƒˆ ëŒ“ê¸€ í™•ì¸
                const myIssues = await githubAPI.get(`/repos/${owner}/${repo}/issues`, {
                  params: { 
                    state: 'all', 
                    creator: GITHUB_USERNAME 
                  }
                });
                
                console.log(`${myIssues.data.length}ê°œì˜ ë‚´ê°€ ìƒì„±í•œ ì´ìŠˆ ë°œê²¬`);
                
                // ì´ìŠˆë³„ë¡œ ìƒˆ ëŒ“ê¸€ í™•ì¸
                for (const issue of myIssues.data) {
                  // PRì´ ì•„ë‹Œ ì´ìŠˆë§Œ ì²˜ë¦¬
                  if (!issue.pull_request) {
                    const comments = await githubAPI.get(issue.comments_url);
                    
                    // ë§ˆì§€ë§‰ í™•ì¸ ì´í›„ ìƒˆ ëŒ“ê¸€ì´ ìˆëŠ”ì§€ í™•ì¸
                    const newComments = comments.data.filter(
                      comment => 
                        new Date(comment.created_at) > lastCheckedTime && 
                        comment.user.login.toLowerCase() !== GITHUB_USERNAME.toLowerCase()
                    );
                    
                    for (const comment of newComments) {
                      // ëŒ“ê¸€ ì‘ì„± ì‹œê°„ì„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                      const commentTime = new Date(comment.created_at);
                      const koreaTimeOptions = { 
                        timeZone: 'Asia/Seoul', 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit', 
                        minute: '2-digit'
                      };
                      const commentTimeStr = commentTime.toLocaleString('ko-KR', koreaTimeOptions);
                      
                      await sendDiscordNotification({
                        title: `ğŸ’¬ ì´ìŠˆì— ìƒˆ ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: #${issue.number}`,
                        description: `**ì´ìŠˆ**: ${issue.title}\n**ëŒ“ê¸€ ì‘ì„±ì**: ${comment.user.login}\n**ì‘ì„± ì‹œê°„**: ${commentTimeStr}\n\n**ëŒ“ê¸€ ë‚´ìš©**:\n${truncateText(comment.body, 200)}`,
                        url: comment.html_url,
                        author: comment.user.login,
                        repo: `${owner}/${repo}`
                      });
                    }
                  }
                }
                
                // 3. ë‚´ê°€ ì–¸ê¸‰ëœ(@username) ì´ìŠˆ/ëŒ“ê¸€ í™•ì¸
                const mentionedIssues = await githubAPI.get(`/repos/${owner}/${repo}/issues`, {
                  params: { 
                    state: 'all', 
                    mentioned: GITHUB_USERNAME,
                    since: lastCheckedTime.toISOString()
                  }
                });
                
                console.log(`${mentionedIssues.data.length}ê°œì˜ ë‚´ê°€ ì–¸ê¸‰ëœ ì´ìŠˆ ë°œê²¬`);
                
                for (const issue of mentionedIssues.data) {
                  if (!issue.pull_request) {
                    // ì´ìŠˆ ì–¸ê¸‰ ì‹œê°„ì„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                    const issueUpdateTime = new Date(issue.updated_at);
                    const koreaTimeOptions = { 
                      timeZone: 'Asia/Seoul', 
                      year: 'numeric', 
                      month: '2-digit', 
                      day: '2-digit',
                      hour: '2-digit', 
                      minute: '2-digit'
                    };
                    const issueUpdateTimeStr = issueUpdateTime.toLocaleString('ko-KR', koreaTimeOptions);
                    
                    await sendDiscordNotification({
                      title: `ğŸ”” ì´ìŠˆì—ì„œ ì–¸ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤: #${issue.number}`,
                      description: `**ì´ìŠˆ**: ${issue.title}\n**ì‘ì„±ì**: ${issue.user.login}\n**ì–¸ê¸‰ ì‹œê°„**: ${issueUpdateTimeStr}`,
                      url: issue.html_url,
                      author: issue.user.login,
                      repo: `${owner}/${repo}`
                    });
                  }
                }
                
              } catch (error) {
                console.error(`Error checking issues for ${owner}/${repo}:`, error.message);
              }
            }
          }

          // ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ í™•ì¸ (GitHub GraphQL API ì‚¬ìš©)
          async function checkForNewOrgDiscussions() {
            console.log('ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ í™•ì¸ ì¤‘...');
            
            // í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì¡°ì§ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” í•˜ë“œì½”ë”©
            const orgName = 'talkpick'; // ì—¬ëŸ¬ë¶„ì˜ ì¡°ì§ ì´ë¦„
            
            try {
              // ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (GraphQL API ì‚¬ìš©)
              const orgDiscussionsQuery = {
                query: `
                  query {
                    organization(login: "${orgName}") {
                      discussions(first: 20, orderBy: {field: CREATED_AT, direction: DESC}) {
                        nodes {
                          id
                          title
                          url
                          number
                          author {
                            login
                          }
                          createdAt
                          updatedAt
                          body
                          category {
                            name
                          }
                          comments(first: 20, orderBy: {field: CREATED_AT, direction: DESC}) {
                            nodes {
                              id
                              author {
                                login
                              }
                              createdAt
                              url
                              body
                              isAnswer
                              reactionGroups {
                                content
                                users {
                                  totalCount
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                `
              };
              
              const discussionsResponse = await axios.post(
                'https://api.github.com/graphql',
                orgDiscussionsQuery,
                {
                  headers: {
                    Authorization: `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                  }
                }
              );
              
              // ì¡°ì§ ë˜ëŠ” ë””ìŠ¤ì»¤ì…˜ ì ‘ê·¼ì´ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ê±´ë„ˆë›°ê¸°
              if (!discussionsResponse.data.data.organization || 
                  !discussionsResponse.data.data.organization.discussions) {
                console.log(`${orgName} ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
              }
              
              const discussions = discussionsResponse.data.data.organization.discussions.nodes || [];
              
              console.log(`${discussions.length}ê°œì˜ ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ ë°œê²¬`);
              
              // 2. ìƒˆ ë””ìŠ¤ì»¤ì…˜ í™•ì¸
              for (const discussion of discussions) {
                const createdAt = new Date(discussion.createdAt);
                
                // ìµœê·¼ ìƒì„±ëœ ë””ìŠ¤ì»¤ì…˜ ì•Œë¦¼
                if (createdAt > lastCheckedTime) {
                  // ë³¸ì¸ì´ ì‘ì„±í•œ ê²ƒì€ ì œì™¸
                  if (discussion.author.login.toLowerCase() !== GITHUB_USERNAME.toLowerCase()) {
                    // ë””ìŠ¤ì»¤ì…˜ ì‘ì„± ì‹œê°„ì„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                    const koreaTimeOptions = { 
                      timeZone: 'Asia/Seoul', 
                      year: 'numeric', 
                      month: '2-digit', 
                      day: '2-digit',
                      hour: '2-digit', 
                      minute: '2-digit'
                    };
                    const discussionTimeStr = createdAt.toLocaleString('ko-KR', koreaTimeOptions);
                    
                    // ë””ìŠ¤ì»¤ì…˜ ë‚´ìš© ìš”ì•½
                    const discussionBody = discussion.body ? truncateText(discussion.body, 200) : '(ë‚´ìš© ì—†ìŒ)';
                    
                    await sendDiscordNotification({
                      title: `ğŸ“£ ìƒˆ ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: #${discussion.number}`,
                      description: `**ì œëª©**: ${discussion.title}\n**ì¹´í…Œê³ ë¦¬**: ${discussion.category ? discussion.category.name : 'ì—†ìŒ'}\n**ì‘ì„±ì**: ${discussion.author.login}\n**ì‘ì„± ì‹œê°„**: ${discussionTimeStr}\n\n**ë‚´ìš© ìš”ì•½**:\n${discussionBody}`,
                      url: discussion.url,
                      author: discussion.author.login,
                      repo: `${orgName} (ì¡°ì§)`
                    });
                  }
                }
                
                // 3. ë””ìŠ¤ì»¤ì…˜ ëŒ“ê¸€ í™•ì¸
                const comments = discussion.comments.nodes || [];
                
                for (const comment of comments) {
                  const commentCreatedAt = new Date(comment.createdAt);
                  
                  if (commentCreatedAt > lastCheckedTime && 
                      comment.author.login.toLowerCase() !== GITHUB_USERNAME.toLowerCase()) {
                        
                    // ìì‹ ì´ ì‘ì„±í•œ ë””ìŠ¤ì»¤ì…˜ì— ë‹¬ë¦° ëŒ“ê¸€ ì•Œë¦¼
                    if (discussion.author.login.toLowerCase() === GITHUB_USERNAME.toLowerCase()) {
                      // ëŒ“ê¸€ ì‘ì„± ì‹œê°„ì„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                      const koreaTimeOptions = { 
                        timeZone: 'Asia/Seoul', 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit', 
                        minute: '2-digit'
                      };
                      const commentTimeStr = commentCreatedAt.toLocaleString('ko-KR', koreaTimeOptions);
                      
                      // ë‹µë³€ìœ¼ë¡œ í‘œì‹œë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
                      const isAnswer = comment.isAnswer ? 'âœ… ë‹µë³€ìœ¼ë¡œ í‘œì‹œë¨' : '';
                      
                      await sendDiscordNotification({
                        title: `ğŸ’¬ ë‚´ ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ì— ìƒˆ ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: #${discussion.number}`,
                        description: `**ë””ìŠ¤ì»¤ì…˜**: ${discussion.title}\n**ëŒ“ê¸€ ì‘ì„±ì**: ${comment.author.login}\n**ì‘ì„± ì‹œê°„**: ${commentTimeStr}\n${isAnswer}\n\n**ëŒ“ê¸€ ë‚´ìš©**:\n${truncateText(comment.body, 200)}`,
                        url: comment.url,
                        author: comment.author.login,
                        repo: `${orgName} (ì¡°ì§)`
                      });
                    }
                    
                    // ìì‹ ì˜ ëŒ“ê¸€ì´ ë‹¬ë¦° ë””ìŠ¤ì»¤ì…˜ì˜ ìƒˆ ëŒ“ê¸€ ì•Œë¦¼
                    else {
                      const userCommented = comments.some(c => 
                        c.author.login.toLowerCase() === GITHUB_USERNAME.toLowerCase() && 
                        new Date(c.createdAt) < commentCreatedAt
                      );
                      
                      if (userCommented) {
                        // ëŒ“ê¸€ ì‘ì„± ì‹œê°„ì„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                        const koreaTimeOptions = { 
                          timeZone: 'Asia/Seoul', 
                          year: 'numeric', 
                          month: '2-digit', 
                          day: '2-digit',
                          hour: '2-digit', 
                          minute: '2-digit'
                        };
                        const commentTimeStr = commentCreatedAt.toLocaleString('ko-KR', koreaTimeOptions);
                        
                        // ë‹µë³€ìœ¼ë¡œ í‘œì‹œë˜ì—ˆëŠ”ì§€ ì—¬ë¶€
                        const isAnswer = comment.isAnswer ? 'âœ… ë‹µë³€ìœ¼ë¡œ í‘œì‹œë¨' : '';
                        
                        await sendDiscordNotification({
                          title: `ğŸ’¬ ë‚´ê°€ ì°¸ì—¬í•œ ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ì— ìƒˆ ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: #${discussion.number}`,
                          description: `**ë””ìŠ¤ì»¤ì…˜**: ${discussion.title}\n**ëŒ“ê¸€ ì‘ì„±ì**: ${comment.author.login}\n**ì‘ì„± ì‹œê°„**: ${commentTimeStr}\n${isAnswer}\n\n**ëŒ“ê¸€ ë‚´ìš©**:\n${truncateText(comment.body, 200)}`,
                          url: comment.url,
                          author: comment.author.login,
                          repo: `${orgName} (ì¡°ì§)`
                        });
                      }
                    }
                  }
                }
                
                // 4. ë‚´ê°€ ì–¸ê¸‰ëœ(@username) ë””ìŠ¤ì»¤ì…˜ í™•ì¸
                // ë””ìŠ¤ì»¤ì…˜ ë³¸ë¬¸ì´ë‚˜ ëŒ“ê¸€ì—ì„œ ë‚´ ì‚¬ìš©ìëª…ì´ ì–¸ê¸‰ë˜ì—ˆëŠ”ì§€ í™•ì¸
                const myMention = `@${GITHUB_USERNAME}`;
                const updatedAt = new Date(discussion.updatedAt);
                
                if (updatedAt > lastCheckedTime) {
                  // ë³¸ë¬¸ì— ì–¸ê¸‰ëœ ê²½ìš°
                  if (discussion.body && discussion.body.includes(myMention) && 
                      discussion.author.login.toLowerCase() !== GITHUB_USERNAME.toLowerCase()) {
                    
                    // ì–¸ê¸‰ ì‹œê°„ì„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                    const koreaTimeOptions = { 
                      timeZone: 'Asia/Seoul', 
                      year: 'numeric', 
                      month: '2-digit', 
                      day: '2-digit',
                      hour: '2-digit', 
                      minute: '2-digit'
                    };
                    const mentionTimeStr = updatedAt.toLocaleString('ko-KR', koreaTimeOptions);
                    
                    await sendDiscordNotification({
                      title: `ğŸ”” ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ì—ì„œ ì–¸ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤: #${discussion.number}`,
                      description: `**ë””ìŠ¤ì»¤ì…˜**: ${discussion.title}\n**ì‘ì„±ì**: ${discussion.author.login}\n**ì–¸ê¸‰ ì‹œê°„**: ${mentionTimeStr}`,
                      url: discussion.url,
                      author: discussion.author.login,
                      repo: `${orgName} (ì¡°ì§)`
                    });
                  }
                  
                  // ëŒ“ê¸€ì— ì–¸ê¸‰ëœ ê²½ìš°
                  for (const comment of comments) {
                    const commentCreatedAt = new Date(comment.createdAt);
                    
                    if (commentCreatedAt > lastCheckedTime && 
                        comment.body && comment.body.includes(myMention) && 
                        comment.author.login.toLowerCase() !== GITHUB_USERNAME.toLowerCase()) {
                      
                      // ì–¸ê¸‰ ì‹œê°„ì„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                      const koreaTimeOptions = { 
                        timeZone: 'Asia/Seoul', 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit', 
                        minute: '2-digit'
                      };
                      const mentionTimeStr = commentCreatedAt.toLocaleString('ko-KR', koreaTimeOptions);
                      
                      await sendDiscordNotification({
                        title: `ğŸ”” ì¡°ì§ ë””ìŠ¤ì»¤ì…˜ ëŒ“ê¸€ì—ì„œ ì–¸ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤: #${discussion.number}`,
                        description: `**ë””ìŠ¤ì»¤ì…˜**: ${discussion.title}\n**ëŒ“ê¸€ ì‘ì„±ì**: ${comment.author.login}\n**ì–¸ê¸‰ ì‹œê°„**: ${mentionTimeStr}\n\n**ëŒ“ê¸€ ë‚´ìš©**:\n${truncateText(comment.body, 200)}`,
                        url: comment.url,
                        author: comment.author.login,
                        repo: `${orgName} (ì¡°ì§)`
                      });
                    }
                  }
                }
              }
            } catch (error) {
              console.error(`Error checking organization discussions:`, error.message);
              if (error.response) {
                console.error('ì‘ë‹µ ìƒíƒœ ì½”ë“œ:', error.response.status);
                console.error('ì‘ë‹µ ë°ì´í„° ì¼ë¶€:', JSON.stringify(error.response.data).substring(0, 500));
              }
            }
          }
          
          // ìƒˆ PR ë¦¬ë·° ìš”ì²­ í™•ì¸
          async function checkForReviewRequests() {
            console.log('PR ë¦¬ë·° ìš”ì²­ í™•ì¸ ì¤‘...');
            
            for (const repoFullName of REPOS_TO_MONITOR) {
              const [owner, repo] = repoFullName.split('/');
              
              try {
                console.log(`ì €ì¥ì†Œ í™•ì¸ ì¤‘: ${owner}/${repo}`);
                
                // ì—´ë¦° PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const response = await githubAPI.get(`/repos/${owner}/${repo}/pulls`, {
                  params: { state: 'open' }
                });
                
                console.log(`${response.data.length}ê°œì˜ ì—´ë¦° PR ë°œê²¬`);
                
                // ê° PRì— ëŒ€í•´ ë¦¬ë·° ìš”ì²­ í™•ì¸
                for (const pr of response.data) {
                  // PR ì„¸ë¶€ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë¦¬ë·° ìš”ì²­ í¬í•¨)
                  const prDetail = await githubAPI.get(`/repos/${owner}/${repo}/pulls/${pr.number}`);
                  
                  // ë‚˜ì—ê²Œ ë¦¬ë·° ìš”ì²­ì´ ìˆëŠ”ì§€ í™•ì¸
                  const requestedReviewers = prDetail.data.requested_reviewers || [];
                  const isRequestedForMe = requestedReviewers.some(
                    reviewer => reviewer.login.toLowerCase() === GITHUB_USERNAME.toLowerCase()
                  );
                  
                  // PR ì—…ë°ì´íŠ¸ ì‹œê°„ì´ ë§ˆì§€ë§‰ í™•ì¸ ì´í›„ì¸ì§€ í™•ì¸
                  const prUpdatedAt = new Date(pr.updated_at);
                  
                  if (isRequestedForMe && prUpdatedAt > lastCheckedTime) {
                    console.log(`ìƒˆ ë¦¬ë·° ìš”ì²­ ë°œê²¬: ${pr.title}`);
                    
                    // Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
                    await sendDiscordNotification({
                      title: `ğŸ” ìƒˆ PR ë¦¬ë·° ìš”ì²­ì´ ì™”ìŠµë‹ˆë‹¤`,
                      description: `PR: ${pr.title}`,
                      url: pr.html_url,
                      author: pr.user.login,
                      repo: `${owner}/${repo}`
                    });
                  }
                }
              } catch (error) {
                console.error(`Error checking ${owner}/${repo} PRs:`, error.message);
              }
            }
          }
          
          // ë‚´ PRì— ë¦¬ë·°ê°€ ë‹¬ë ¸ëŠ”ì§€ í™•ì¸
          async function checkForNewReviews() {
            console.log('PR ë¦¬ë·° í™•ì¸ ì¤‘...');
            
            for (const repoFullName of REPOS_TO_MONITOR) {
              const [owner, repo] = repoFullName.split('/');
              
              try {
                // ë‚´ê°€ ì‘ì„±í•œ ì—´ë¦° PR ê°€ì ¸ì˜¤ê¸°
                const response = await githubAPI.get(`/repos/${owner}/${repo}/pulls`, {
                  params: { state: 'open', creator: GITHUB_USERNAME }
                });
                
                console.log(`${response.data.length}ê°œì˜ ë‚´ê°€ ì‘ì„±í•œ PR ë°œê²¬`);
                
                // ê° PRì— ëŒ€í•´ ìƒˆ ë¦¬ë·° í™•ì¸
                for (const pr of response.data) {
                  // PRì˜ ë¦¬ë·° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                  const reviews = await githubAPI.get(`/repos/${owner}/${repo}/pulls/${pr.number}/reviews`);
                  
                  // ë§ˆì§€ë§‰ í™•ì¸ ì´í›„ ìƒˆ ë¦¬ë·°ê°€ ìˆëŠ”ì§€ í™•ì¸
                  const newReviews = reviews.data.filter(
                    review => new Date(review.submitted_at) > lastCheckedTime
                  );
                  
                  console.log(`PR #${pr.number}ì— ${newReviews.length}ê°œì˜ ìƒˆ ë¦¬ë·° ë°œê²¬`);
                  
                  // ìƒˆ ë¦¬ë·°ê°€ ìˆìœ¼ë©´ ì•Œë¦¼ ë³´ë‚´ê¸°
                  for (const review of newReviews) {
                    // ë¦¬ë·° ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€ì™€ í…ìŠ¤íŠ¸ ì„¤ì •
                    const stateEmoji = getReviewStateEmoji(review.state);
                    let stateText = review.state;
                    
                    switch(review.state) {
                      case 'APPROVED':
                        stateText = 'ìŠ¹ì¸ë¨';
                        break;
                      case 'CHANGES_REQUESTED':
                        stateText = 'ë³€ê²½ ìš”ì²­ë¨';
                        break;
                      case 'COMMENTED':
                        stateText = 'ì½”ë©˜íŠ¸ ì‘ì„±ë¨';
                        break;
                    }
                    
                    // ë¦¬ë·° ë‚´ìš© ìš”ì•½ (200ì ì œí•œ)
                    const reviewBody = review.body ? truncateText(review.body, 200) : '(ë‚´ìš© ì—†ìŒ)';
                    
                    // ë¦¬ë·° ì‘ì„± ì‹œê°„ì„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
                    const reviewTime = new Date(review.submitted_at);
                    const koreaTimeOptions = { 
                      timeZone: 'Asia/Seoul', 
                      year: 'numeric', 
                      month: '2-digit', 
                      day: '2-digit',
                      hour: '2-digit', 
                      minute: '2-digit'
                    };
                    const reviewTimeStr = reviewTime.toLocaleString('ko-KR', koreaTimeOptions);
                    
                    await sendDiscordNotification({
                      title: `âš ï¸ PRì— ìƒˆ ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: ${stateEmoji} ${stateText}`,
                      description: `**PR**: ${pr.title}\n**ë¦¬ë·°ì–´**: ${review.user.login}\n**ì‘ì„± ì‹œê°„**: ${reviewTimeStr}\n\n**ë‚´ìš© ìš”ì•½**:\n${reviewBody}`,
                      url: review.html_url,
                      author: review.user.login,
                      repo: `${owner}/${repo}`
                    });
                  }
                }
              } catch (error) {
                console.error(`Error checking reviews for ${owner}/${repo}:`, error.message);
              }
            }
          }
          
          // ë¦¬ë·° ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
          function getReviewStateEmoji(state) {
            switch (state) {
              case 'APPROVED': return 'âœ…';
              case 'CHANGES_REQUESTED': return 'âŒ';
              case 'COMMENTED': return 'ğŸ’¬';
              default: return 'â“';
            }
          }
          
          // í…ìŠ¤íŠ¸ ìë¥´ê¸° í•¨ìˆ˜
          function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
          }
          
          // Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
          async function sendDiscordNotification(data) {
            try {
              await axios.post(DISCORD_WEBHOOK_URL, {
                embeds: [{
                  title: data.title,
                  description: data.description,
                  url: data.url,
                  color: 3447003, // íŒŒë€ìƒ‰
                  author: {
                    name: data.author
                  },
                  footer: {
                    text: `Repository: ${data.repo}`
                  },
                  timestamp: new Date()
                }]
              });
              console.log('ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:', data.title);
            } catch (error) {
              console.error('Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error.message);
              console.error('ì˜¤ë¥˜ ì„¸ë¶€ ì •ë³´:', error.response ? error.response.data : 'ì‘ë‹µ ë°ì´í„° ì—†ìŒ');
            }
          }          
          async function main() {
            try {            
              // ê° ê¸°ëŠ¥ë³„ë¡œ í™•ì¸ ì‹¤í–‰
              await checkForReviewRequests();
              await checkForNewReviews();
              await checkForNewIssuesAndComments();
              await checkForNewOrgDiscussions();
              
              console.log('ëª¨ë“  í™•ì¸ ì™„ë£Œ');
            } catch (error) {
              console.error('ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
          }
          
          // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          main();
          EOL
      
      - name: Run notification script
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_USERNAME: ${{ secrets.MY_GITHUB_USERNAME }}
          REPOS_TO_MONITOR: ${{ secrets.REPOS_TO_MONITOR }}
        run: node github-monitor.js
