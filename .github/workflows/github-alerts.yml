name: GitHub Alerts

on:
  schedule:
    - cron: '*/30 * * * *'  # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  monitor-github:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install axios
      
      - name: Debug environment
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_USERNAME: ${{ secrets.MY_GITHUB_USERNAME }}
          REPOS_TO_MONITOR: ${{ secrets.REPOS_TO_MONITOR }}
        run: |
          node -e "
          console.log('í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹…:');
          console.log('GITHUB_TOKEN:', process.env.GITHUB_TOKEN ? 'ìˆìŒ (ê¸¸ì´: ' + process.env.GITHUB_TOKEN.length + ')' : 'ì—†ìŒ');
          console.log('DISCORD_WEBHOOK_URL:', process.env.DISCORD_WEBHOOK_URL ? 'ìˆìŒ (ê¸¸ì´: ' + process.env.DISCORD_WEBHOOK_URL.length + ')' : 'ì—†ìŒ');
          console.log('GITHUB_USERNAME:', process.env.GITHUB_USERNAME ? 'ìˆìŒ (' + process.env.GITHUB_USERNAME + ')' : 'ì—†ìŒ');
          console.log('MY_GITHUB_USERNAME:', process.env.MY_GITHUB_USERNAME ? 'ìˆìŒ (' + process.env.MY_GITHUB_USERNAME + ')' : 'ì—†ìŒ');
          "
      
      - name: Create notification script
        run: |
          cat > github-monitor.js << 'EOL'
          const axios = require('axios');

          // í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
          const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
          const DISCORD_WEBHOOK_URL = process.env.DISCORD_WEBHOOK_URL;
          const GITHUB_USERNAME = process.env.GITHUB_USERNAME; 
          
          // í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹…
          console.log('==== í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹… ====');
          console.log('GITHUB_TOKEN:', GITHUB_TOKEN ? 'ìˆìŒ (ê¸¸ì´: ' + GITHUB_TOKEN.length + ')' : 'ì—†ìŒ');
          console.log('DISCORD_WEBHOOK_URL:', DISCORD_WEBHOOK_URL ? 'ìˆìŒ (ê¸¸ì´: ' + DISCORD_WEBHOOK_URL.length + ')' : 'ì—†ìŒ');
          console.log('GITHUB_USERNAME:', GITHUB_USERNAME ? 'ìˆìŒ (' + GITHUB_USERNAME + ')' : 'ì—†ìŒ');
          console.log('==== í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹… ë ====');
          
          // JSON ë¬¸ìì—´ë¡œ ì €ì¥ëœ ì €ì¥ì†Œ ëª©ë¡ì„ íŒŒì‹±
          const REPOS_TO_MONITOR = JSON.parse(process.env.REPOS_TO_MONITOR || '[]');
          
          // ë§ˆì§€ë§‰ í™•ì¸ ì‹œê°„ (State ìœ ì§€ê°€ ì•ˆ ë˜ë¯€ë¡œ í•­ìƒ ìµœê·¼ 2ì‹œê°„ë§Œ í™•ì¸)
          const lastCheckedTime = new Date();
          lastCheckedTime.setHours(lastCheckedTime.getHours() - 2);
          
          console.log('GitHub ì•Œë¦¼ ì²´ì»¤ ì‹œì‘ë¨');
          console.log('ëª¨ë‹ˆí„°ë§ ì¤‘ì¸ ì €ì¥ì†Œ:', REPOS_TO_MONITOR);
          console.log('ì‚¬ìš©ì:', GITHUB_USERNAME);
          console.log('ë§ˆì§€ë§‰ í™•ì¸ ì‹œê°„:', lastCheckedTime.toISOString());
          
          // GitHub API í˜¸ì¶œ ì„¤ì •
          const githubAPI = axios.create({
            baseURL: 'https://api.github.com',
            headers: {
              Authorization: `token ${GITHUB_TOKEN}`,
              Accept: 'application/vnd.github.v3+json'
            }
          });
          
          // GitHub APIì— ì‚¬ìš©í•  ì¶”ê°€ í—¤ë” (Discussions APIìš©)
          const discussionsHeader = {
            headers: {
              Authorization: `token ${GITHUB_TOKEN}`,
              Accept: 'application/vnd.github.v3+json,application/vnd.github.squirrel-girl-preview'
            }
          };
          
          // ìƒˆ PR ë¦¬ë·° ìš”ì²­ í™•ì¸
          async function checkForReviewRequests() {
            console.log('PR ë¦¬ë·° ìš”ì²­ í™•ì¸ ì¤‘...');
            
            for (const repoFullName of REPOS_TO_MONITOR) {
              const [owner, repo] = repoFullName.split('/');
              
              try {
                console.log(`ì €ì¥ì†Œ í™•ì¸ ì¤‘: ${owner}/${repo}`);
                
                // ì—´ë¦° PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const response = await githubAPI.get(`/repos/${owner}/${repo}/pulls`, {
                  params: { state: 'open' }
                });
                
                console.log(`${response.data.length}ê°œì˜ ì—´ë¦° PR ë°œê²¬`);
                
                // ê° PRì— ëŒ€í•´ ë¦¬ë·° ìš”ì²­ í™•ì¸
                for (const pr of response.data) {
                  // PR ì„¸ë¶€ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë¦¬ë·° ìš”ì²­ í¬í•¨)
                  const prDetail = await githubAPI.get(`/repos/${owner}/${repo}/pulls/${pr.number}`);
                  
                  // ë‚˜ì—ê²Œ ë¦¬ë·° ìš”ì²­ì´ ìˆëŠ”ì§€ í™•ì¸
                  const requestedReviewers = prDetail.data.requested_reviewers || [];
                  const isRequestedForMe = requestedReviewers.some(
                    reviewer => reviewer.login.toLowerCase() === GITHUB_USERNAME.toLowerCase()
                  );
                  
                  // PR ì—…ë°ì´íŠ¸ ì‹œê°„ì´ ë§ˆì§€ë§‰ í™•ì¸ ì´í›„ì¸ì§€ í™•ì¸
                  const prUpdatedAt = new Date(pr.updated_at);
                  
                  if (isRequestedForMe && prUpdatedAt > lastCheckedTime) {
                    console.log(`ìƒˆ ë¦¬ë·° ìš”ì²­ ë°œê²¬: ${pr.title}`);
                    
                    // Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
                    await sendDiscordNotification({
                      title: `ğŸ” ìƒˆ PR ë¦¬ë·° ìš”ì²­ì´ ì™”ìŠµë‹ˆë‹¤`,
                      description: `PR: ${pr.title}`,
                      url: pr.html_url,
                      author: pr.user.login,
                      repo: `${owner}/${repo}`
                    });
                  }
                }
              } catch (error) {
                console.error(`Error checking ${owner}/${repo} PRs:`, error.message);
              }
            }
          }
          
          // ë‚´ PRì— ë¦¬ë·°ê°€ ë‹¬ë ¸ëŠ”ì§€ í™•ì¸
          async function checkForNewReviews() {
            console.log('PR ë¦¬ë·° í™•ì¸ ì¤‘...');
            
            for (const repoFullName of REPOS_TO_MONITOR) {
              const [owner, repo] = repoFullName.split('/');
              
              try {
                // ë‚´ê°€ ì‘ì„±í•œ ì—´ë¦° PR ê°€ì ¸ì˜¤ê¸°
                const response = await githubAPI.get(`/repos/${owner}/${repo}/pulls`, {
                  params: { state: 'open', creator: GITHUB_USERNAME }
                });
                
                console.log(`${response.data.length}ê°œì˜ ë‚´ê°€ ì‘ì„±í•œ PR ë°œê²¬`);
                
                // ê° PRì— ëŒ€í•´ ìƒˆ ë¦¬ë·° í™•ì¸
                for (const pr of response.data) {
                  // PRì˜ ë¦¬ë·° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                  const reviews = await githubAPI.get(`/repos/${owner}/${repo}/pulls/${pr.number}/reviews`);
                  
                  // ë§ˆì§€ë§‰ í™•ì¸ ì´í›„ ìƒˆ ë¦¬ë·°ê°€ ìˆëŠ”ì§€ í™•ì¸
                  const newReviews = reviews.data.filter(
                    review => new Date(review.submitted_at) > lastCheckedTime
                  );
                  
                  console.log(`PR #${pr.number}ì— ${newReviews.length}ê°œì˜ ìƒˆ ë¦¬ë·° ë°œê²¬`);
                  
                  // ìƒˆ ë¦¬ë·°ê°€ ìˆìœ¼ë©´ ì•Œë¦¼ ë³´ë‚´ê¸°
                  for (const review of newReviews) {
                    await sendDiscordNotification({
                      title: `âš ï¸ PRì— ìƒˆ ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`,
                      description: `PR: ${pr.title} - ${getReviewStateEmoji(review.state)} ${review.state}`,
                      url: review.html_url,
                      author: review.user.login,
                      repo: `${owner}/${repo}`
                    });
                  }
                }
              } catch (error) {
                console.error(`Error checking reviews for ${owner}/${repo}:`, error.message);
              }
            }
          }
          
          // ë¦¬ë·° ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€ ë°˜í™˜
          function getReviewStateEmoji(state) {
            switch (state) {
              case 'APPROVED': return 'âœ…';
              case 'CHANGES_REQUESTED': return 'âŒ';
              case 'COMMENTED': return 'ğŸ’¬';
              default: return 'â“';
            }
          }
          
          // í…ìŠ¤íŠ¸ ìë¥´ê¸° í•¨ìˆ˜
          function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
          }
          
          // Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
          async function sendDiscordNotification(data) {
            try {
              await axios.post(DISCORD_WEBHOOK_URL, {
                embeds: [{
                  title: data.title,
                  description: data.description,
                  url: data.url,
                  color: 3447003, // íŒŒë€ìƒ‰
                  author: {
                    name: data.author
                  },
                  footer: {
                    text: `Repository: ${data.repo}`
                  },
                  timestamp: new Date()
                }]
              });
              console.log('ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:', data.title);
            } catch (error) {
              console.error('Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error.message);
              console.error('ì˜¤ë¥˜ ì„¸ë¶€ ì •ë³´:', error.response ? error.response.data : 'ì‘ë‹µ ë°ì´í„° ì—†ìŒ');
            }
          }
          
          // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°
          async function sendTestNotification() {
            try {
              console.log('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹œë„ ì¤‘...');
              await axios.post(DISCORD_WEBHOOK_URL, {
                embeds: [{
                  title: 'ğŸ”” GitHub ì•Œë¦¼ ë´‡ í…ŒìŠ¤íŠ¸',
                  description: 'ì´ ë©”ì‹œì§€ëŠ” GitHub ì•Œë¦¼ ë´‡ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.',
                  color: 65280, // ë…¹ìƒ‰
                  footer: {
                    text: `í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ - ${new Date().toISOString()}`
                  }
                }]
              });
              console.log('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ!');
              return true;
            } catch (error) {
              console.error('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error.message);
              console.error('ì˜¤ë¥˜ ì„¸ë¶€ ì •ë³´:', error.response ? error.response.data : 'ì‘ë‹µ ë°ì´í„° ì—†ìŒ');
              return false;
            }
          }
          
          // ë©”ì¸ í•¨ìˆ˜
          async function main() {
            try {
              // ë¨¼ì € í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë³´ë‚´ê¸°
              const testSuccess = await sendTestNotification();
              
              if (!testSuccess) {
                console.error('í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì‹¤íŒ¨. ë‚˜ë¨¸ì§€ ê¸°ëŠ¥ ì‹¤í–‰ ì¤‘ë‹¨.');
                return;
              }
              
              // ê° ê¸°ëŠ¥ë³„ë¡œ í™•ì¸ ì‹¤í–‰
              await checkForReviewRequests();
              await checkForNewReviews();
              
              console.log('ëª¨ë“  í™•ì¸ ì™„ë£Œ');
            } catch (error) {
              console.error('ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
          }
          
          // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          main();
          EOL
      
      - name: Run notification script
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_USERNAME: ${{ secrets.MY_GITHUB_USERNAME }}
          REPOS_TO_MONITOR: ${{ secrets.REPOS_TO_MONITOR }}
        run: node github-monitor.js
